(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[931],{5437:function(e,t,i){Promise.resolve().then(i.bind(i,2858))},2858:function(e,t,i){"use strict";i.d(t,{default:function(){return tv}});var s,n,r,l,a,o,c=i(7437),h=i(6727),d=i(2368),u=i(2265),p=i(4131);let x=(0,u.createContext)(0n),f=()=>(0,u.useContext)(x);function g(e){let{children:t,interval:i}=e,[s,n]=(0,u.useState)(0n);return(0,u.useEffect)(()=>{let e=setInterval(()=>n(e=>e+1n),i);return()=>{clearInterval(e)}},[i]),(0,c.jsx)(x.Provider,{value:s,children:t})}function v(e){var t,i;let{surface:s,direction:n,width:r,height:l}=e,a=f(),[o,x]=(0,u.useState)();return(0,u.useEffect)(()=>{let{x:e,y:t}=(0,p.h8)(s,n,Number(a%2n));x([e,t])},[a,n,s]),(0,c.jsx)(d.Z,{visibility:void 0===o?"hidden":"visible",width:r,height:l,justifyContent:"center",alignItems:"center",children:(0,c.jsx)(h.Z,{component:"img",src:"https://rpgen.org/dq/img/dq/char.png",sx:{imageRendering:"pixelated",width:p.Wz,height:p.Wz,scale:"".concat(r/p.Wz),objectFit:"none",objectPosition:"-".concat(null!==(t=null==o?void 0:o[0])&&void 0!==t?t:0,"px -").concat(null!==(i=null==o?void 0:o[1])&&void 0!==i?i:0,"px")}})})}var m=i(6548),y=i(511),j=i(2561),b=i(3026),w=i.n(b),k=i(9514),Z=i.n(k),M=i(5090),C=i.n(M),S=i(8105),_=i.n(S),P=i(9099),T=i(1096);let I=(0,P.Ue)(e=>({open:!1,setOpen:t=>e({open:t})}));function E(){let{open:e,setOpen:t}=I();return(0,c.jsx)(T.Z,{onClose:()=>t(!1),open:e,children:"comming soon"})}var L=i(8227);let W=i.n(L)()({level:"info",browser:{asObject:!0}});var A=i(1929),z=i(8784),O=i(385),R=i(824),D=i(8038),H=i(3983),F=i(6488);let N=(0,P.Ue)(e=>({open:!1,setOpen:t=>e({open:t})}));function U(){let{open:e,setOpen:t}=N(),[i,s]=(0,u.useState)(!1),n=tc(e=>e.loadMapText),[r,l]=(0,u.useState)(!1),[a,o]=(0,u.useState)(""),[h,p]=(0,u.useState)("");return(0,c.jsxs)(T.Z,{onClose:()=>t(!1),open:e,children:[(0,c.jsx)(R.Z,{children:"マップを読み込む"}),(0,c.jsx)(O.Z,{children:(0,c.jsxs)(d.Z,{spacing:1,children:[(0,c.jsx)(D.Z,{control:(0,c.jsx)(A.Z,{checked:i}),label:"圧縮されたマップを読み込む",onChange:(e,t)=>s(t)}),(0,c.jsx)(H.Z,{sx:{width:"500px"},helperText:h,error:!!h,onFocus:()=>p(""),multiline:!0,rows:5,placeholder:i?"MQCQogSg8gUAzAGgOzDAOQCIxsAQgcQFkYALAFzIAcBnALgHp6B3FgOg...":"#HERO\n3,7#END\n\n#BGM\n...\n",value:a,onChange:e=>o(e.currentTarget.value)})]})}),(0,c.jsx)(z.Z,{children:(0,c.jsx)(m.Z,{disabled:r,onClick:()=>{l(!0),p("");try{let e=i?(0,F.decompressFromEncodedURIComponent)(a.replace(/^L1/,"")):a;n(e),t(!1)}catch(e){p("マップデータの読み込みに問題が発生しました"),W.error({error:e},String(e))}l(!1)},children:"読み込む"})})]})}function G(){let e=I(),t=N(),i=(0,u.useMemo)(()=>Object.values(p.VD).filter(e=>"number"==typeof e),[]),s=(0,u.useMemo)(()=>(0,c.jsx)(d.Z,{direction:"row",children:w()((0,j.Z)(i),Z()(4),C()(e=>(0,c.jsx)(v,{width:64,height:64,surface:e,direction:p.Nm.West},e)),_())}),[i]);return(0,c.jsx)(g,{interval:600,children:(0,c.jsxs)(d.Z,{justifyContent:"center",alignItems:"center",height:"100%",spacing:3,children:[s,(0,c.jsx)(y.Z,{variant:"h6",component:"span",children:"RPGENマップエディタ「ENRPG」にようこそ！"}),(0,c.jsxs)(d.Z,{justifyContent:"center",alignItems:"center",children:[(0,c.jsx)(y.Z,{children:"……まだここにはなにもないようです"}),(0,c.jsx)(y.Z,{children:"作成するか、マップを読み込んでみましょう！"})]}),(0,c.jsxs)(d.Z,{direction:"row",spacing:1,children:[(0,c.jsx)(m.Z,{onClick:()=>e.setOpen(!0),variant:"outlined",children:"新規作成"}),(0,c.jsx)(m.Z,{variant:"outlined",onClick:()=>t.setOpen(!0),children:"マップを読み込む"})]})]})})}var q=i(2228),X=i(9546),Y=i(9778),Q=i(8144),B=i(6085),K=i(2149),V=i(2218),$=i(2444);let J=new Map,ee=new Set,et=e=>{if(ee.has(e))return null;let t=J.get(e);if(t instanceof HTMLImageElement)return t;t instanceof Promise||es(e)},ei=new $.Z({concurrency:1,interval:0,intervalCap:1,autoStart:!0}),es=e=>{let t=J.get(e);if(t instanceof HTMLImageElement)return Promise.resolve(t);if(t instanceof Promise)return t;let i=Promise.withResolvers();return J.set(e,i.promise),ei.add(()=>new Promise((t,s)=>{let n=document.createElement("img"),r=()=>{n.onload=n.onerror=null};n.onload=()=>{r(),J.set(e,n),i.resolve(n),t(n)},n.onerror=t=>{r(),ee.add(e),i.reject(t),s(t)},n.src=e})),i.promise};(s=l||(l={}))[s.Uninitialized=0]="Uninitialized",s[s.Primary=1]="Primary",s[s.Secondary=2]="Secondary",s[s.Auxiliary=4]="Auxiliary",s[s.Fourth=8]="Fourth",s[s.Fifth=16]="Fifth";let en=(e,t)=>(e.buttons&t)!=0;var er=new WeakMap;class el{setX(e){this.x=e}setY(e){this.y=e}setPosition(e,t){this.setX(e),this.setY(t)}setZoomRate(e){this.zoomRate=e}setScale(e,t,i){let s=this.scale,n=(this.x+t)/s,r=(this.y+i)/s;this.setPosition(Math.round(n*e-t),Math.round(r*e-i)),this.scale=e}attachElement(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;this.detachElement();let s=new AbortController;e.addEventListener("contextmenu",e=>{e.preventDefault()});let n=!1;e.addEventListener("pointerdown",t=>{en(t,l.Secondary)&&(n=!0,e.setPointerCapture(t.pointerId))},{signal:s.signal}),e.addEventListener("pointermove",e=>{n&&this.setPosition(this.x-e.movementX,this.y-e.movementY)},{signal:s.signal}),e.addEventListener("mouseup",e=>{en(e,l.Secondary)||(n=!1)},{signal:s.signal}),e.tabIndex=1;let r=1;e.addEventListener("keyup",()=>{r=1}),e.addEventListener("keydown",e=>{e.repeat&&r<i&&(r+=.01)>i&&(r=i);let s=t*r|0;switch(e.code){case"KeyW":case"ArrowUp":this.setY(this.y-s);break;case"KeyS":case"ArrowDown":this.setY(this.y+s);break;case"KeyA":case"ArrowLeft":this.setX(this.x-s);break;case"KeyD":case"ArrowRight":this.setX(this.x+s)}},{signal:s.signal}),e.addEventListener("wheel",t=>{let i=t.deltaY>0?this.scale/this.zoomRate:this.scale*this.zoomRate,s=e.getBoundingClientRect(),n=t.clientX-s.left,r=t.clientY-s.top;this.setScale(i,n,r)},{signal:s.signal}),(0,Y._)(this,er,s)}detachElement(){var e;null===(e=(0,q._)(this,er))||void 0===e||e.abort(),(0,Y._)(this,er,void 0)}constructor(){(0,X._)(this,er,{writable:!0,value:void 0}),this.x=0,this.y=0,this.scale=1,this.zoomRate=1.07}}class ea{constructor(e,t){this.id=ea.currentId++,this.start=e,this.end=t}}ea.currentId=0;var eo=new WeakMap;class ec{attachElement(e){this.detachElement();let t=new AbortController,i=t=>[t.pageX-e.offsetLeft,t.pageY-e.offsetTop];e.addEventListener("pointerdown",t=>{let[s,n]=i(t),r={x:s,y:n};this.position=r,en(t,l.Primary)&&(t.getModifierState("Shift")?(this.position=r,this.selection=new ea(r,r),this.selecting=!0,e.setPointerCapture(t.pointerId)):this.selection=void 0)},{signal:t.signal}),e.addEventListener("pointermove",e=>{let[t,s]=i(e);this.position={x:t,y:s},en(e,l.Primary)&&e.getModifierState("Shift")&&this.selection&&(this.selection.end={x:this.position.x,y:this.position.y})},{signal:t.signal}),e.addEventListener("mouseup",e=>{en(e,l.Primary)&&e.getModifierState("Shift")||(this.selection&&this.selection.start.x===this.selection.end.x&&this.selection.start.y===this.selection.end.y&&(this.selection=void 0),this.selecting=!1)},{signal:t.signal}),e.addEventListener("pointerleave",()=>{this.position=void 0},{signal:t.signal}),(0,Y._)(this,eo,t)}detachElement(){var e;null===(e=(0,q._)(this,eo))||void 0===e||e.abort(),(0,Y._)(this,eo,void 0)}constructor(){(0,X._)(this,eo,{writable:!0,value:void 0}),this.selecting=!1}}(n=a||(a={}))[n.Gaming=0]="Gaming",n[n.Invert=1]="Invert",(r=o||(o={}))[r.Medium=0]="Medium",r[r.Large=1]="Large",r[r.Largest=2]="Largest";let eh=e=>{switch(e){case 0:return[15,11.25];case 1:return[30,22.5];case 2:return[60,45]}};var ed=new WeakSet,eu=new WeakMap,ep=new WeakMap,ex=new WeakSet,ef=new WeakMap,eg=new WeakMap,ev=new WeakMap,em=new WeakSet,ey=new WeakMap,ej=new WeakMap,eb=new WeakMap,ew=new WeakSet;class ek{setLayers(e){this.layers={...this.layers,...e}}resize(){let e=this.canvas,t=e.parentElement;t&&(e.width!==t.offsetWidth&&(e.width=t.offsetWidth),e.height!==t.offsetHeight&&(e.height=t.offsetHeight))}renderNotFound(e,t){let i=et("https://rpgen.org/dq/sprites/img/404Chip.png");if(!i)return;let{context:s,camera:n}=this,r=this.chipSize;s.drawImage(i,r*e-n.x,r*t-n.y,r,r)}renderTileMap(e){let{canvas:t,context:i,camera:s}=this,n=this.chipSize,r=t.width/n,l=t.height/n,a=s.x/n,o=s.y/n;for(let t=0|o;t<l+o;t++)if(!(t<0)&&!(t>=p.To.MAX_WIDTH))for(let l=0|a;l<r+a;l++){if(l<0||l>=p.To.MAX_WIDTH)continue;let r=e.get(l,t);if(r)switch(r.sprite.type){case p.PA.DQStillSprite:{let e=et("https://rpgen.org/dq/img/dq/map.png");if(null===e){this.renderNotFound(l,t);break}if(void 0===e)break;i.drawImage(e,r.sprite.surface.x*p.Wz,r.sprite.surface.y*p.Wz,p.Wz,p.Wz,n*l-s.x,n*t-s.y,n,n);break}case p.PA.CustomStillSprite:{let e=et("https://rpgen.org/dq/sprites/".concat(r.sprite.id,"/sprite.png"));if(null===e){this.renderNotFound(l,t);break}if(void 0===e)break;i.drawImage(e,0,0,p.Wz,p.Wz,n*l-s.x,n*t-s.y,n,n)}}}}renderHumans(){let{context:e,camera:t}=this,i=(0,q._)(this,eu),s=this.chipSize;for(let n of this.rpgMap.humans)switch(n.sprite.type){case p.PA.DQAnimationSprite:{let r=et("https://rpgen.org/dq/img/dq/char.png");if(null===r){this.renderNotFound(n.position.x,n.position.y);break}if(void 0===r)break;let l=(0,p.h8)(n.sprite.surface,n.direction,i);e.drawImage(r,l.x,l.y,p.Wz,p.Wz,s*n.position.x-t.x,s*n.position.y-t.y,s,s);break}case p.PA.CustomAnimationSprite:{let r=et("https://rpgen.cc/dq/sAnims/res/".concat(n.sprite.id,".png"));if(null===r){this.renderNotFound(n.position.x,n.position.y);break}if(void 0===r)break;e.drawImage(r,p.Wz*i,p.Wz*n.direction,p.Wz,p.Wz,s*n.position.x-t.x,s*n.position.y-t.y,s,s);break}case p.PA.CustomStillSprite:{let i=et("https://rpgen.org/dq/sprites/".concat(n.sprite.id,"/sprite.png"));if(null===i){this.renderNotFound(n.position.x,n.position.y);break}if(void 0===i)break;e.drawImage(i,0,0,p.Wz,p.Wz,s*n.position.x-t.x,s*n.position.y-t.y,s,s)}}}renderPoints(e,t){let i=et("https://rpgen.org/dq/img/dq/map.png");if(!i)return;let{context:s,camera:n}=this,r=this.chipSize;for(let l of e)s.drawImage(i,t.x*p.Wz,t.y*p.Wz,p.Wz,p.Wz,r*l.position.x-n.x,r*l.position.y-n.y,r,r)}renderCollisionDetection(){if(!this.renderingCollisionDetection)return;let{canvas:e,context:t,camera:i}=this,s=this.chipSize,n=e.width/s,r=e.height/s,l=i.x/s,a=i.y/s;t.save(),(0,B._)(this,ex,eC).call(this,.5);for(let e=0|a;e<r+a;e++){if(e<0||e>=p.To.MAX_WIDTH)continue;let r=s>>1;for(let a=0|l;a<n+l;a++){if(a<0||a>=p.To.MAX_WIDTH)continue;let n=this.rpgMap.humans.get(a,e),l=this.rpgMap.objects.get(a,e),o=this.rpgMap.floor.get(a,e);(n||(null==l?void 0:l.collision)||!(null==l?void 0:l.collision)&&(null==o?void 0:o.collision))&&(t.beginPath(),t.arc(s*a-i.x+r,s*e-i.y+r,r,0,2*Math.PI),t.closePath(),t.fill())}}t.restore()}setOverlayContentColor(e){this.overlayContentColor=e}setRPGENGrid(e){this.rpgenGrid=e}renderRPGENGrid(){let{canvas:e,context:t,camera:i,rpgenGrid:s}=this;if(void 0===s)return;let n=this.chipSize,[r,l]=eh(s);t.save(),(0,B._)(this,ex,eC).call(this);let a=e.width/n,o=e.height/n,c=Math.round((a-r)/2),h=Math.round((o-l)/2);t.lineWidth=2*i.scale,t.strokeRect(i.x>0?n-i.x%n+c*n:Math.abs(i.x%n)+c*n,i.y>0?n-i.y%n+h*n:Math.abs(i.y%n)+h*n,r*n,l*n),t.restore()}renderOutline(){let{context:e,camera:t}=this,i=this.chipSize;e.save(),(0,B._)(this,ex,eC).call(this),e.strokeRect(0-t.x,0-t.y,i*p.To.MAX_WIDTH,i*p.To.MAX_WIDTH),e.restore()}renderPointer(){let{pointer:e,context:t,camera:i}=this,s=this.chipSize;if(t.save(),t.fillStyle="#fff",t.globalAlpha=.5,e.position){let n=Math.floor(e.position.x/s+this.camera.x/s),r=Math.floor(e.position.y/s+this.camera.y/s);t.fillRect(s*n-i.x,s*r-i.y,s,s)}let n=(0,q._)(this,ey);if(n){let e=Math.min(n.start.x,n.end.x),r=Math.min(n.start.y,n.end.y),l=Math.max(n.start.x,n.end.x),a=Math.max(n.start.y,n.end.y);t.fillStyle="red",t.fillRect(s*e-i.x,s*r-i.y,s*(l-e+1),s*(a-r+1))}t.restore()}clear(){let e=this.canvas;this.context.clearRect(0,0,e.width,e.height)}render(){this.resize(),this.clear(),this.context.imageSmoothingEnabled=!1;let e=this.layers;e.floor&&this.renderTileMap(this.rpgMap.floor),e.objects&&this.renderTileMap(this.rpgMap.objects),e.humans&&this.renderHumans();let{rpgMap:t}=this;e.teleportPoints&&this.renderPoints(t.teleportPoints,p._$),e.lookPoints&&this.renderPoints(t.lookPoints,p.NE),e.eventPoints&&this.renderPoints(t.eventPoints,p.c7),this.renderCollisionDetection(),this.renderRPGENGrid(),this.renderOutline(),this.renderPointer()}startTicking(){if(this.ticking)return;this.ticking=!0;let e=t=>{this.ticking&&((0,Y._)(this,eu,(t/p.V1|0)%2),(0,q._)(this,ep)>=360&&(0,Y._)(this,ep,0),(0,Q._)(this,ep).value++,this.chipSize=(0,B._)(this,ed,eM).call(this),(0,B._)(this,em,eS).call(this),(0,B._)(this,ew,e_).call(this),this.render(),requestAnimationFrame(e))};requestAnimationFrame(e)}stopTicking(){this.ticking=!1}constructor(e){(0,K._)(this,ed),(0,K._)(this,ex),(0,K._)(this,em),(0,K._)(this,ew),(0,X._)(this,eu,{writable:!0,value:void 0}),(0,X._)(this,ep,{writable:!0,value:void 0}),(0,X._)(this,ef,{writable:!0,value:void 0}),(0,X._)(this,eg,{writable:!0,value:void 0}),(0,X._)(this,ev,{writable:!0,value:void 0}),(0,X._)(this,ey,{writable:!0,value:void 0}),(0,X._)(this,ej,{writable:!0,value:void 0}),(0,X._)(this,eb,{writable:!0,value:void 0}),this.rpgMap=e,this.layers={floor:!0,objects:!0,humans:!0,teleportPoints:!0,lookPoints:!0,eventPoints:!0},(0,Y._)(this,eu,0),this.renderingCollisionDetection=!1,this.overlayContentColor=0,(0,Y._)(this,ep,0),this.rpgenGrid=0,this.cameraMoved=!1,this.ticking=!1;let t=document.createElement("canvas");t.style.display="block",t.style.imageRendering="pixalated";let i=t.getContext("2d",{alpha:!1});if(!i)throw TypeError();let s=new el,n=new ec;s.attachElement(t),n.attachElement(t),this.canvas=t,this.context=i,this.camera=s,this.pointer=n,this.chipSize=(0,B._)(this,ed,eM).call(this)}}var eZ={writable:!0,value:64};function eM(){return(0,V._)(ek,ek,eZ)*this.camera.scale|0}function eC(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,{context:t}=this;switch(t.globalAlpha=e,this.overlayContentColor){case 0:t.strokeStyle=t.fillStyle="hsla(".concat((0,q._)(this,ep)," 100% 50% / ").concat(e,")");break;case 1:t.strokeStyle=t.fillStyle="rgba(255, 255, 255, ".concat(e,")"),t.globalCompositeOperation="difference"}}function eS(){if((0,q._)(this,ef)===this.camera.x&&(0,q._)(this,eg)===this.camera.y&&(0,q._)(this,ev)===this.camera.scale){this.cameraMoved=!1;return}(0,Y._)(this,ef,this.camera.x),(0,Y._)(this,eg,this.camera.y),(0,Y._)(this,ev,this.camera.scale),this.cameraMoved=!0}function e_(){let{camera:e,pointer:t}=this;if(!t.selection){(0,Y._)(this,ey,void 0);return}let i=(0,q._)(this,ej);if(!t.selecting||((0,q._)(this,eb)!==t.selection.id&&(0,Y._)(this,ey,void 0),i&&i.start.x===t.selection.start.x&&i.start.y===t.selection.start.y&&i.end.x===t.selection.end.x&&i.end.y===t.selection.end.y&&!this.cameraMoved))return;(0,Y._)(this,ej,{...t.selection});let s=this.chipSize;(0,Y._)(this,ey,{start:((0,q._)(this,eb)===t.selection.id||t.selecting)&&(0,q._)(this,ey)?(0,q._)(this,ey).start:{x:Math.floor(t.selection.start.x/s+e.x/s),y:Math.floor(t.selection.start.y/s+e.y/s)},end:{x:Math.floor(t.selection.end.x/s+e.x/s),y:Math.floor(t.selection.end.y/s+e.y/s)}}),(0,Y._)(this,eb,t.selection.id)}var eP=new WeakMap,eT=new WeakMap,eI=new WeakMap,eE=new WeakMap;class eL{putFloorTile(e){let t=(0,p.hi)(e);try{this.renderer.rpgMap.floor.set(e.position.x,e.position.y,t)}catch(e){}}putObjectTile(e){let t=(0,p.hi)(e);try{this.renderer.rpgMap.objects.set(e.position.x,e.position.y,t)}catch(e){}}onMouseDown(e){return(0,q._)(this,eT).add(e),()=>{(0,q._)(this,eT).delete(e)}}onMouseMove(e){return(0,q._)(this,eI).add(e),()=>{(0,q._)(this,eI).delete(e)}}onMouseUp(e){return(0,q._)(this,eE).add(e),()=>{(0,q._)(this,eE).delete(e)}}mount(e){this.mounted&&this.unmount();let t=this.renderer,i=new AbortController;t.canvas.addEventListener("pointerdown",e=>{if((1&e.buttons)!=0)for(let i of(0,q._)(this,eT))i(Math.floor((e.pageX-t.canvas.offsetLeft+t.camera.x)/t.chipSize),Math.floor((e.pageY-t.canvas.offsetTop+t.camera.y)/t.chipSize))},{signal:i.signal}),t.canvas.addEventListener("mousemove",e=>{for(let i of(0,q._)(this,eI))i(Math.floor((e.pageX-t.canvas.offsetLeft+t.camera.x)/t.chipSize),Math.floor((e.pageY-t.canvas.offsetTop+t.camera.y)/t.chipSize))},{signal:i.signal}),t.canvas.addEventListener("mouseup",e=>{if((1&e.buttons)==0)for(let e of(0,q._)(this,eE))e()},{signal:i.signal}),e.append(t.canvas),t.startTicking(),(0,Y._)(this,eP,i),this.mounted=!0}unmount(){var e;if(!this.mounted)return;null===(e=(0,q._)(this,eP))||void 0===e||e.abort(),(0,Y._)(this,eP,void 0);let t=this.renderer;t.stopTicking(),t.camera.detachElement(),t.pointer.detachElement(),t.canvas.remove(),this.mounted=!1}constructor(e){(0,X._)(this,eP,{writable:!0,value:void 0}),(0,X._)(this,eT,{writable:!0,value:void 0}),(0,X._)(this,eI,{writable:!0,value:void 0}),(0,X._)(this,eE,{writable:!0,value:void 0}),this.mounted=!1,(0,Y._)(this,eT,new Set),(0,Y._)(this,eI,new Set),(0,Y._)(this,eE,new Set),this.renderer=new ek(e)}}var eW=i(1733),eA=i(9806),ez=i(7630),eO=i(9064),eR=i(7318),eD=i(335),eH=i(8027),eF=i(8639);function eN(e){let{width:t,height:i,title:s,children:n,onClose:r}=e,[a,o]=(0,u.useState)(!1),[p,x]=(0,u.useState)(null);return(0,c.jsx)(eH.Z,{ref:x,sx:{width:t,height:a?void 0:i,position:"fixed",top:"calc(50svh - ".concat(i/2,"px)"),left:"calc(50svw - ".concat(t/2,"px)")},children:(0,c.jsxs)(d.Z,{height:"100%",children:[(0,c.jsxs)(d.Z,{padding:1,width:"100%",direction:"row",alignItems:"center",justifyContent:"space-between",sx:{cursor:"grab",":active":{cursor:"grabbing"}},onPointerDown:e=>{en(e,l.Primary)&&e.currentTarget.setPointerCapture(e.pointerId)},onPointerMove:e=>{p&&en(e,l.Primary)&&(p.style.left="".concat(p.offsetLeft+e.movementX,"px"),p.style.top="".concat(p.offsetTop+e.movementY,"px"))},children:[(0,c.jsx)(y.Z,{color:"text.primary",sx:{userSelect:"none"},children:s}),(0,c.jsxs)(d.Z,{spacing:1,direction:"row",alignItems:"center",children:[(0,c.jsx)(eF.Z,{title:a?"戻す":"最小化する",children:(0,c.jsx)(eD.Z,{size:"small",disableTouchRipple:!0,onClick:()=>o(e=>!e),children:(0,c.jsx)(eO.Z,{})})}),(0,c.jsx)(eF.Z,{title:"閉じる",children:(0,c.jsx)(eD.Z,{onClick:()=>r(),disableTouchRipple:!0,size:"small",children:(0,c.jsx)(ez.Z,{})})})]})]}),(0,c.jsx)(eR.Z,{}),(0,c.jsx)(h.Z,{padding:1,display:a?"none":void 0,overflow:"auto",flex:1,children:n})]})})}let eU=()=>{let[e,t]=(0,u.useState)(!1);return(0,u.useEffect)(()=>{t(!0)},[]),e};var eG=i(2419),eq=i(2011),eX=i(7225),eY=i(3502);function eQ(){var e;let[,t]=(0,u.useState)(!1),i=tc(e=>e.editor),s=eU(),{mode:n,setMode:r}=(0,eX.tv)(),[l,h]=(0,u.useState)(!1),[p,x]=(0,u.useState)({floor:!0,objects:!0,humans:!0,teleportPoints:!0,lookPoints:!0,eventPoints:!0}),f=(0,u.useMemo)(()=>(0,c.jsx)(d.Z,{justifyContent:"space-around",height:"100%",children:Object.entries(p).map(e=>{let[t,s]=e,n=(()=>{switch(t){case"floor":return"地面";case"objects":return"物";case"humans":return"人";case"teleportPoints":return"マップ移動ポイント";case"lookPoints":return"しらべるポイント";case"eventPoints":return"イベントポイント"}})();if(n)return(0,c.jsx)(D.Z,{label:n,control:(0,c.jsx)(A.Z,{checked:s,onChange:(e,s)=>{null==i||i.renderer.setLayers({[t]:s}),x(e=>({...e,[t]:s}))}})},t)})}),[p,null==i?void 0:null===(e=i.renderer)||void 0===e?void 0:e.setLayers]);return(0,c.jsxs)(c.Fragment,{children:[l&&!!i&&(0,c.jsx)(eN,{onClose:()=>h(!1),title:"レイヤーコントロール",width:350,height:350,children:f}),(0,c.jsx)(eY.Hc,{menuItemsData:{label:"表示",items:[{disabled:!i,label:"カメラ",items:[{label:"位置をリセット",callback:()=>null==i?void 0:i.renderer.camera.setPosition(0,0)},{label:"拡大率をリセット",callback:()=>{if(i){let e=i.renderer.canvas.getBoundingClientRect(),t=Math.round(e.width/2),s=Math.round(e.height/2);null==i||i.renderer.camera.setScale(1,t,s)}}}]},{disabled:!i,label:"RPGENグリッド",rightIcon:(null==i?void 0:i.renderer.rpgenGrid)!==void 0?(0,c.jsx)(eG.Z,{}):void 0,items:[["なし",void 0],["通常",o.Medium],["大きい",o.Large],["最大",o.Largest]].map(e=>{let[s,n]=e;return{label:s,rightIcon:(null==i?void 0:i.renderer.rpgenGrid)===n?(0,c.jsx)(eG.Z,{}):void 0,callback:()=>{null==i||i.renderer.setRPGENGrid(n),t(e=>!e)}}})},{disabled:!s,label:"カラーテーマ",items:[["ライト","light"],["ダーク","dark"],["システムと同期","system"]].map(e=>{let[t,i]=e;return{label:t,rightIcon:i===n?(0,c.jsx)(eG.Z,{}):void 0,callback:()=>r(i)}})},{label:"オーバーレイ表示の色",items:[["ゲーミング",a.Gaming],["反転",a.Invert]].map(e=>{let[s,n]=e;return{label:s,rightIcon:(null==i?void 0:i.renderer.overlayContentColor)===n?n===a.Gaming?(0,c.jsx)(eq.Z,{}):(0,c.jsx)(eG.Z,{}):void 0,callback:()=>{null==i||i.renderer.setOverlayContentColor(n),t(e=>!e)}}})},{disabled:!i,rightIcon:(null==i?void 0:i.renderer.renderingCollisionDetection)?(0,c.jsx)(eG.Z,{}):void 0,label:"当たり判定",callback:()=>{i&&(i.renderer.renderingCollisionDetection=!i.renderer.renderingCollisionDetection,t(e=>!e))}},{disabled:!i,rightIcon:l?(0,c.jsx)(eG.Z,{}):void 0,label:"レイヤーコントロール",callback:()=>h(e=>!e)}]}})]})}var eB=i(7699),eK=i(1093),eV=i(225),e$=i(6282),eJ=i(8549),e0=i(8409),e1=i(7351),e2=i(1651),e5=i(8918),e8=i(8743),e3=i(4893),e4=i(7183),e6=i(8290),e9=i.n(e6);let e7={Mylist:"mylist",Custom:"custom",DQ:"dq",History:"history"},te={Floor:"floor",Objects:"objects"},tt=(0,P.Ue)(e=>({open:!1,setOpen:t=>e({open:t}),activeTab:e7.Mylist,setActiveTab:t=>e({activeTab:t}),activeLayer:te.Floor,setActiveLayer:t=>e({activeLayer:t})}));function ti(){let{open:e,setOpen:t}=tt(),{activeTab:i,setActiveTab:s,activeLayer:n,setActiveLayer:r}=tt(e=>({activeTab:e.activeTab,setActiveTab:e.setActiveTab,activeLayer:e.activeLayer,setActiveLayer:e.setActiveLayer})),[l,a]=(0,u.useState)(""),[o,x]=(0,u.useState)(!1),[f,g]=(0,u.useState)(""),{editor:v,sprites:m,setSprites:y}=tc(),[j,b]=(0,u.useState)();(0,u.useEffect)(()=>{let e,t;if(!v)return;let i=!1,s=v.onMouseDown((s,n)=>{i=!0,e=s,t=n}),r=v.onMouseMove((s,r)=>{if(j&&i){if(console.log(j),n===te.Floor){if(v.putFloorTile({position:{x:s,y:r},collision:o,sprite:j}),void 0!==e&&void 0!==t)for(let i of e9()(e,t,s,r))v.putFloorTile({position:{x:i.x,y:i.y},collision:o,sprite:j})}else if(n===te.Objects&&(v.putObjectTile({position:{x:s,y:r},collision:o,sprite:j}),void 0!==e&&void 0!==t))for(let i of e9()(e,t,s,r))v.putObjectTile({position:{x:i.x,y:i.y},collision:o,sprite:j});e=s,t=r}}),l=v.onMouseUp(()=>{i=!1,e=t=void 0});return()=>{s(),r(),l()}},[v,o,n,j]);let w=()=>(0,c.jsx)(D.Z,{control:(0,c.jsx)(A.Z,{checked:o,onChange:(e,t)=>x(t)}),label:"当たり判定"}),k=()=>(0,c.jsxs)(eJ.Z,{fullWidth:!0,children:[(0,c.jsx)(e0.Z,{id:"demo-row-radio-buttons-group-label",children:"レイヤ"}),(0,c.jsxs)(e8.Z,{row:!0,"aria-labelledby":"demo-row-radio-buttons-group-label",value:n,onChange:(e,t)=>{(t===te.Floor||t===te.Objects)&&r(t)},children:[(0,c.jsx)(D.Z,{value:te.Floor,control:(0,c.jsx)(e5.Z,{}),label:"地面"}),(0,c.jsx)(D.Z,{value:te.Objects,control:(0,c.jsx)(e5.Z,{}),label:"物"})]})]}),Z=(0,u.useRef)(null);return e&&(0,c.jsx)(eK.ZP,{value:i,children:(0,c.jsx)(eN,{width:800,height:600,title:"編集",onClose:()=>t(!1),children:(0,c.jsxs)(d.Z,{direction:"row",height:"100%",children:[(0,c.jsxs)(eV.Z,{orientation:"vertical",onChange:(e,t)=>s(t),children:[(0,c.jsx)(e4.Z,{value:e7.Mylist,label:"マイリスト"}),(0,c.jsx)(e4.Z,{value:e7.Custom,label:"カスタム素材"}),(0,c.jsx)(e4.Z,{value:e7.DQ,label:"標準素材"}),(0,c.jsx)(e4.Z,{value:e7.History,label:"履歴"})]}),(0,c.jsx)(e$.Z,{value:e7.Mylist,sx:{flex:1},children:(0,c.jsxs)(d.Z,{spacing:2,height:"100%",children:[(0,c.jsx)(w,{}),(0,c.jsx)(k,{}),(0,c.jsx)(()=>(0,c.jsx)(eH.Z,{}),{}),(0,c.jsx)(eH.Z,{sx:{flex:1}})]})}),(0,c.jsx)(e$.Z,{value:e7.Custom,sx:{flex:1},children:(0,c.jsxs)(d.Z,{spacing:2,height:"100%",children:[(0,c.jsx)(w,{}),(0,c.jsx)(k,{}),(0,c.jsxs)(d.Z,{direction:"row",spacing:1,alignItems:"center",children:[(0,c.jsx)(H.Z,{fullWidth:!0,error:!!f,helperText:f||" ",size:"small",sx:{flex:1},label:"タイル素材のID",value:l,onChange:e=>a(e.currentTarget.value)}),(0,c.jsx)(eD.Z,{onClick:async()=>{let e;let t=Number.parseInt(l.trim(),10);if(!Number.isFinite(t)||Number.isNaN(t)){g("IDを数値としてパースできません");return}try{e=await es("https://rpgen.org/dq/sprites/".concat(encodeURIComponent(t.toString()),"/sprite.png"))}catch(e){g("スプライト画像の取得に失敗しました"),W.error(e);return}g(""),Z.current&&(Z.current.innerHTML="",Z.current.append(e)),b({type:p.PA.CustomStillSprite,id:t})},children:(0,c.jsx)(eB.Z,{})})]}),(0,c.jsx)(eH.Z,{ref:Z,style:{padding:"20px",textAlign:"center"}}),(0,c.jsx)(eH.Z,{sx:{flex:1}})]})}),(0,c.jsx)(e$.Z,{value:e7.DQ,sx:{flex:1},children:(0,c.jsxs)(d.Z,{spacing:2,height:"100%",children:[(0,c.jsx)(w,{}),(0,c.jsx)(k,{}),(0,c.jsxs)(eJ.Z,{fullWidth:!0,children:[(0,c.jsx)(e1.Z,{children:"初期素材"}),(0,c.jsxs)(e3.Z,{value:"human",label:"種類",children:[(0,c.jsx)(e2.Z,{value:"human",children:"地面（歩ける）"}),(0,c.jsx)(e2.Z,{value:"any",children:"地面（歩けない）"}),(0,c.jsx)(e2.Z,{value:"any",children:"物（ぶつかる）"}),(0,c.jsx)(e2.Z,{value:"any",children:"物（ぶつからない）"}),(0,c.jsx)(e2.Z,{value:"any",children:"-----------"}),(0,c.jsx)(e2.Z,{value:"any",children:"階段"}),(0,c.jsx)(e2.Z,{value:"any",children:"建物"}),(0,c.jsx)(e2.Z,{value:"any",children:"マップ移動ポイント"}),(0,c.jsx)(e2.Z,{value:"any",children:"扉"}),(0,c.jsx)(e2.Z,{value:"any",children:"宝箱"}),(0,c.jsx)(e2.Z,{value:"any",children:"しらべるポイント"}),(0,c.jsx)(e2.Z,{value:"any",children:"-----------"}),(0,c.jsx)(e2.Z,{value:"any",children:"イベントポイント"}),(0,c.jsx)(e2.Z,{value:"any",children:"-----------"}),(0,c.jsx)(e2.Z,{value:"any",children:"掲示板/本/ネット"})]})]}),(0,c.jsx)(eH.Z,{sx:{flex:1}})]})}),(0,c.jsx)(e$.Z,{value:e7.History,sx:{flex:1},children:(0,c.jsxs)(d.Z,{spacing:2,height:"100%",children:[(0,c.jsx)(w,{}),(0,c.jsx)(k,{}),(0,c.jsx)(eH.Z,{sx:{flex:1}}),(0,c.jsx)(h.Z,{children:"ページネーション的なやつ"})]})})]})})})}function ts(){let{open:e,setOpen:t}=tt(),i=tc(e=>e.editor);return console.log(i),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(ti,{}),(0,c.jsx)(eY.Hc,{menuItemsData:{label:"編集",items:[{disabled:!i,label:"編集ウィンドウ",rightIcon:e?(0,c.jsx)(eG.Z,{}):void 0,callback:()=>t(!e)}]}})]})}let tn=(0,P.Ue)(e=>({open:!1,setOpen:t=>e({open:t})})),tr=(e,t)=>{let i=new Blob([e],{type:"text/plain"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=t,n.click(),URL.revokeObjectURL(s)};function tl(){let{open:e,setOpen:t}=tn(),[i,s]=(0,u.useState)(!1),n=tc(e=>e.editor),[r,l]=(0,u.useState)(!1),[a,o]=(0,u.useState)("");return(0,c.jsxs)(T.Z,{onClose:()=>t(!1),open:e,children:[(0,c.jsx)(R.Z,{children:"マップを保存する"}),(0,c.jsx)(O.Z,{children:(0,c.jsxs)(d.Z,{spacing:1,children:[(0,c.jsx)(D.Z,{control:(0,c.jsx)(A.Z,{checked:i}),label:"圧縮されたマップを保存する",onChange:(e,t)=>s(t)}),!!a&&(0,c.jsx)(y.Z,{color:"error",children:a})]})}),(0,c.jsx)(z.Z,{children:(0,c.jsx)(m.Z,{disabled:r,onClick:()=>{l(!0),o("");let e=null==n?void 0:n.renderer.rpgMap;if(!e){o("虚無を保存しました"),l(!1);return}let t=p.Vd.stringify(e);try{let e=i?(0,F.compressToEncodedURIComponent)(t):t;tr(e,"".concat(Date.now(),".txt"))}catch(e){o("マップデータの保存に問題が発生しました"),console.error(e)}l(!1)},children:"保存する"})})]})}function ta(){let e=I(e=>e.setOpen),t=N(e=>e.setOpen),i=tn(e=>e.setOpen),{editor:s,setEditor:n}=tc();return(0,c.jsx)(eY.Hc,{menuItemsData:{label:"ファイル",items:[{label:"新規作成",callback:()=>e(!0)},{label:"マップの読み込み",callback:()=>t(!0)},{disabled:!s,label:"マップの保存",callback:()=>i(!0)},{disabled:!s,label:"閉じる",callback:()=>n(void 0)}]}})}function to(){return(0,c.jsx)(eW.Z,{sx:{backgroundColor:"background.paper"},position:"static",children:(0,c.jsxs)(eA.Z,{variant:"dense",disableGutters:!0,sx:{minHeight:0},children:[(0,c.jsx)(ta,{}),(0,c.jsx)(eQ,{}),(0,c.jsx)(ts,{})]})})}let tc=(0,P.Ue)(e=>({setEditor:t=>e({editor:t}),sprites:[],setSprites:t=>e({sprites:t}),loadMapText:t=>e({editor:new eL(p.Vd.parse(t))})}));function th(){let[e,t]=(0,u.useState)(null),{editor:i}=tc();return(0,u.useEffect)(()=>{if(i&&e)return i.mount(e),()=>{i.unmount()}},[i,e]),(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(E,{}),(0,c.jsx)(U,{}),(0,c.jsx)(tl,{}),(0,c.jsxs)(d.Z,{height:"100svh",overflow:"hidden",children:[(0,c.jsx)(to,{}),(0,c.jsxs)(h.Z,{flex:1,height:"100%",children:[!i&&(0,c.jsx)(G,{}),i&&(0,c.jsx)(h.Z,{height:"100%",ref:t})]})]})]})}class td{static makeHeader(e){return"".concat(td.prefix2).concat(e,"\n")}static*parseChunks(e){let t=e.indexOf(td.prefix2);for(;-1!==t;){let i;let s=e.slice(t+td.prefix2.length).indexOf(td.prefix2),n=(i=-1===s?e.slice(t+td.prefix2.length):e.slice(t+td.prefix2.length,s)).indexOf("\n");-1!==n&&(yield[i.slice(0,n),i.slice(n+1)]),t=s}}static parseTileChipMap(e){let t=new p.To;for(let[i,s]of e.split("\n").entries())for(let[e,n]of s.split(",").entries())t.set(e,i,n.trim());return t}static stringifyTileChipMap(e){let{width:t,height:i}=e.getSize(),s=[],n=0;for(let l=0;l<i;l++){let i=[];for(let s=0;s<t;s++){var r;let t=null!==(r=e.getRaw(s,l))&&void 0!==r?r:"";t.length>n&&(n=t.length),i.push(t)}s.push(i)}let l="";for(let[e,t]of s.entries())for(let[i,s]of(e>0&&(l+="\n"),t.entries()))i>0&&(l+=", "),l+=s.padStart(n," ");return l}constructor(e){this.name=e.name}}td.prefix="## ",td.prefix2="### ";class tu extends td{static lookLike(e){return e.includes("".concat(td.makeHeader("HUMAN")))}static parseInit(e){let t;for(let[i,s]of td.parseChunks(e))"HUMAN"===i&&(t=td.parseTileChipMap(s));return{humans:t}}static stringify(e){let t="";return t+="".concat(td.prefix).concat(e.name),e.humans&&(t+="\n\n".concat(td.makeHeader("HUMAN"),"\n").concat(td.stringifyTileChipMap(e.humans))),t}constructor(e){super(e),this.humans=e.humans}}class tp extends td{static lookLike(e){return e.includes(td.makeHeader("SOUND"))}static parseInit(e){let t;for(let[i,s]of td.parseChunks(e))"SOUND"===i&&(t=td.parseTileChipMap(s));return{sounds:t}}static stringify(e){let t="";return t+="".concat(td.prefix).concat(e.name),e.sounds&&(t+="\n\n".concat(td.makeHeader("SOUND")).concat(td.stringifyTileChipMap(e.sounds))),t}constructor(e){super(e),this.sounds=e.sounds}}class tx extends td{static lookLike(e){return e.includes(td.makeHeader("FLOOR"))||e.includes(td.makeHeader("MAP"))}static parseInit(e){let t,i;for(let[s,n]of td.parseChunks(e))switch(s){case"FLOOR":t=td.parseTileChipMap(n);break;case"MAP":i=td.parseTileChipMap(n)}return{floor:t,objects:i}}static stringify(e){let t="";return t+="".concat(td.prefix).concat(e.name),e.floor&&(t+="\n\n".concat(td.makeHeader("FLOOR")).concat(td.stringifyTileChipMap(e.floor))),e.objects&&(t+="\n\n".concat(td.makeHeader("MAP")).concat(td.stringifyTileChipMap(e.objects))),t}constructor(e){super(e),this.floor=e.floor,this.objects=e.objects}}class tf{static parse(e){let t=e.indexOf("\n"),i=e.slice(tf.prefix.length,t),s=e.slice(t+1),n=[];for(let e of"\n".concat(s).split("\n".concat(td.prefix)).slice(1)){let t;let i=e.indexOf("\n"),s=e.slice(0,i),r=e.slice(i+1);if(tx.lookLike(r)){let e=tx.parseInit(r);if(e.floor||e.objects){let{floor:i,objects:n}=e;t=new tx({name:s,floor:i,objects:n})}}else if(tu.lookLike(r)){let e=tu.parseInit(r);if(e.humans){let{humans:i}=e;t=new tu({name:s,humans:i})}}else if(tp.lookLike(r)){let e=tp.parseInit(r);if(e.sounds){let{sounds:i}=e;t=new tp({name:s,sounds:i})}}t&&(t.name=s,n.push(t))}return new tf({name:i,presets:n})}static parseToArray(e){return e.includes(tf.prefix)?"\n".concat(e.trim()).split("\n".concat(tf.prefix)).slice(1).map(e=>"".concat(tf.prefix).concat(e)).map(tf.parse):[]}static stringify(e){let t="";for(let i of(t+=tf.prefix+e.name,e.presets)){let e;i instanceof tx?e=tx.stringify(i):i instanceof tu?e=tu.stringify(i):i instanceof tp&&(e=tp.stringify(i)),t&&(t+="\n\n".concat(e))}return t}constructor(e){this.name=e.name,this.presets=e.presets}}tf.prefix="# ";let tg=e=>{let t=(0,u.useRef)(!1);(0,u.useEffect)(()=>{if(!t.current)return t.current=!0,e()},[e])};function tv(){let{editor:e,loadMapText:t}=tc(e=>({editor:e.editor,loadMapText:e.loadMapText}));return tg(()=>{e||(async()=>{let i=await fetch("/examples/sample-rpgmap.txt");i.ok&&!e&&t(await i.text())})()}),tg(()=>{(async()=>{let e=await fetch("/examples/sample-mylist.txt");if(e.ok){let t=await e.text();console.log(tf.parseToArray(t))}})()}),(0,c.jsx)(th,{})}}},function(e){e.O(0,[266,686,971,23,744],function(){return e(e.s=5437)}),_N_E=e.O()}]);